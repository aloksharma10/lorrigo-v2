datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

// Consolidated Enums
enum Role {
  ADMIN
  SUBADMIN
  SELLER
  SALESPERSON
  SUPPORT
}

enum OrderType {
  B2C
  B2B
}

enum ShipmentStatus {
  ALL
  NEW
  COURIER_ASSIGNED
  PICKUP_SCHEDULED
  OUT_FOR_PICKUP
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  NDR
  RTO
  RTO_DELIVERED
  EXCEPTION
  CANCELLED_SHIPMENT
  CANCELLED_ORDER

  AWAITING
}

enum PaymentMethod {
  PREPAID
  WALLET
  CARD
  BANK_TRANSFER
  COD
  UPI
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum TransactionType {
  SHIPMENT
  INVOICE
  WALLET_RECHARGE
}

enum DisputeStatus {
  OPENED
  UNDER_REVIEW
  RESOLVED
  REJECTED
}

enum NotificationType {
  EMAIL
  WHATSAPP
  SYSTEM
}

enum RemittanceStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum RemittanceCycle {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

enum DeliveryType {
  EXPRESS
  AIR
  SURFACE
}

enum ZoneLabel {
  Z_A
  Z_B
  Z_C
  Z_D
  Z_E
}

enum Channel {
  CUSTOM
  WEBSITE
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  EMAIL
  SHOPIFY
}

// User Model
model User {
  id       String @id @default(cuid())
  code     String @unique // Custom ID - Format: US-YYMM-XXXXX
  email    String @unique
  name     String
  password String
  phone    String

  role        Role    @default(SELLER)
  is_active   Boolean @default(true)
  is_verified Boolean @default(false)

  // Plan relation
  plan_id String?
  plan    Plan?   @relation(fields: [plan_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  permissions           Permissions[] // Sparse, cached in app layer
  notification_settings NotificationSettings[] // Sparse, cached in app layer

  // Business Details
  business_name String?
  gstin         String? @db.VarChar(15) // Fixed length for GSTIN
  margin        Float   @default(20)

  // Relations
  kyc_details           KycDetails?
  bank_details          BankDetails?
  wallet                UserWallet?
  invoices              Invoice[]                   @relation("UserInvoices")
  remittances           Remittance[]                @relation("UserRemittances")
  shipment_transactions ShipmentTransaction[]       @relation("UserShipmentTransactions")
  invoice_transactions  InvoiceTransaction[]        @relation("UserInvoiceTransactions")
  wallet_transactions   WalletRechargeTransaction[] @relation("UserWalletTransactions")
  orders                Order[]                     @relation("UserOrders")
  shipments             Shipment[]                  @relation("UserShipments")
  hubs                  Hub[]                       @relation("UserHubs")
  disputes              Dispute[]                   @relation("UserDisputes")
  api_requests          ApiRequest[]
  config                SellerConfig?
  address               Address?
  shopify_connection    ShopifyConnection?
  bulk_operations       BulkOperation[]

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  @@index([email])
  @@index([code])
  @@index([phone, role, is_active])
  @@index([plan_id])
}

model Permissions {
  id             String  @id @default(cuid())
  code           String  @unique // Custom ID - Format: PM-YYMM-XXXXX
  name           String
  description    String
  is_active      Boolean @default(true)
  is_verified    Boolean @default(false)
  nav_permission Json?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model NotificationSettings {
  id          String  @id @default(cuid())
  code        String  @unique // Custom ID - Format: NS-YYMM-XXXXX
  name        String
  description String
  is_whatsapp Boolean @default(true)
  is_email    Boolean @default(true)
  is_system   Boolean @default(true)

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// KycDetails Model
model KycDetails {
  id            String   @id @default(cuid())
  user_id       String   @unique
  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  business_type String?  @db.VarChar(50)
  pan           String?  @db.VarChar(10) // Fixed length for PAN
  adhaar        String?  @db.VarChar(12) // Fixed length for Aadhaar
  gst_no        String?  @db.VarChar(15)
  submitted     Boolean  @default(false)
  verified      Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([user_id, verified])
}

// BankDetails Model
model BankDetails {
  id              String   @id @default(cuid())
  user_id         String   @unique
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  acc_holder_name String?  @db.VarChar(100)
  acc_number      String?  @db.VarChar(20)
  ifsc_number     String?  @db.VarChar(11) // Fixed length for IFSC
  acc_type        String?  @db.VarChar(20)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([user_id])
}

// SellerConfig Model
model SellerConfig {
  id      String @id @default(cuid())
  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  max_negative_balance Float? @default(0)

  is_d2c     Boolean  @default(true)
  is_b2b     Boolean  @default(true)
  is_prepaid Boolean  @default(true)
  is_fw      Boolean  @default(true)
  is_rto     Boolean  @default(true)
  is_cod     Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([user_id])
}

// Customer Model
model Customer {
  id    String  @id @default(cuid())
  name  String  @db.VarChar(100)
  email String? @db.VarChar(255)
  phone String  @unique @db.VarChar(15)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  address Address? @relation("CustomerAddresses")
  orders  Order[]  @relation("CustomerOrders")

  @@index([phone, email])
  @@index([name])
}

// Address Model
model Address {
  id         String  @id @default(cuid())
  name       String? @db.VarChar(100)
  address    String  @db.VarChar(255)
  address_2  String? @db.VarChar(255)
  city       String  @db.VarChar(100)
  state      String  @db.VarChar(100)
  pincode    String  @db.VarChar(10)
  country    String  @default("India") @db.VarChar(50)
  is_default Boolean @default(false)
  phone      String? @db.VarChar(15)

  user_id String? @unique
  user    User?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  customer_id String?   @unique
  customer    Customer? @relation("CustomerAddresses", fields: [customer_id], references: [id])

  hub_primary Hub? @relation("HubPrimaryAddress")
  hub_rto     Hub? @relation("HubRTOAddress")

  order_seller_details OrderSellerDetails[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([customer_id, is_default])
  @@index([pincode, city])
}

// Hub Config Model
model HubConfig {
  id String @id @default(cuid())

  is_pickup_enabled           Boolean @default(true)
  is_rto_enabled              Boolean @default(true)
  is_cod_enabled              Boolean @default(true)
  is_prepaid_enabled          Boolean @default(true)
  is_primary                  Boolean @default(false)
  smart_ship_hub_code_surface String  @unique @db.VarChar(50)
  smart_ship_hub_code_express String  @unique @db.VarChar(50)
  smart_ship_hub_code_heavy   String  @unique @db.VarChar(50)

  hub Hub? @relation("HubConfigHub") // inverse side, optional

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// Hub Model
model Hub {
  id                  String  @id @default(cuid())
  code                String  @unique // Custom ID - Format: HB-YYMM-XXXXX
  name                String  @db.VarChar(100)
  contact_person_name String  @db.VarChar(100)
  is_active           Boolean @default(true)
  phone               String
  is_rto_address_same Boolean @default(true)

  user_id String
  user    User   @relation("UserHubs", fields: [user_id], references: [id], onDelete: Cascade)

  address_id String  @unique
  address    Address @relation("HubPrimaryAddress", fields: [address_id], references: [id])

  rto_address_id String?  @unique
  rto_address    Address? @relation("HubRTOAddress", fields: [rto_address_id], references: [id])

  orders Order[] @relation("OrderHub")

  hub_config_id String    @unique // Enforces 1-1
  hub_config    HubConfig @relation("HubConfigHub", fields: [hub_config_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([user_id, is_active])
  @@index([code])
}

model OrderChannelConfig {
  id               String  @id @default(cuid())
  channel          Channel @default(CUSTOM)
  channel_order_id String? @db.VarChar(50)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  orders Order[]

  @@index([channel_order_id])
}

model Package {
  id String @id @default(cuid())

  weight            Float // in kg
  dead_weight       Float
  volumetric_weight Float

  length  Float
  breadth Float
  height  Float

  order Order? @relation("OrderPackage")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// Order Model
model Order {
  id               String         @id @default(cuid())
  code             String         @unique // Will use your custom ID logic
  order_number     String         @db.VarChar(50)
  type             OrderType      @default(B2C)
  status           ShipmentStatus @default(NEW)
  payment_mode     PaymentMethod  @default(COD)
  is_reverse_order Boolean        @default(false)

  order_channel_config_id String
  order_channel_config    OrderChannelConfig @relation(fields: [order_channel_config_id], references: [id])
  order_reference_id      String?
  ewaybill                String?            @db.VarChar(12)
  total_amount            Float
  amount_to_collect       Float?
  applicable_weight       Float

  order_invoice_date   DateTime? @default(now()) // Seller's invoice date
  order_invoice_number String?   @db.VarChar(50) // Seller's invoice number

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user_id     String
  user        User     @relation("UserOrders", fields: [user_id], references: [id], onDelete: Cascade)
  customer_id String
  customer    Customer @relation("CustomerOrders", fields: [customer_id], references: [id], onDelete: Cascade)
  hub_id      String?
  hub         Hub?     @relation("OrderHub", fields: [hub_id], references: [id])

  seller_details_id String
  seller_details    OrderSellerDetails @relation("OrderSellerDetails", fields: [seller_details_id], references: [id])

  package_id String  @unique
  package    Package @relation("OrderPackage", fields: [package_id], references: [id])

  items      OrderItem[]
  payments   Payment[]
  invoice    Invoice?    @relation("OrderInvoice")
  shipment   Shipment?   @relation("OrderShipment")
  dispute    Dispute?    @relation("OrderDispute")
  remittance Remittance? @relation("OrderRemittances")
  billing    Billing[]

  // B2B Specific
  freight_type   Int? @default(0)
  pickup_type    Int? @default(0)
  insurance_type Int? @default(0)

  @@unique([order_number, user_id])
  @@index([user_id, customer_id, status])
  @@index([created_at(sort: Desc)]) // For partitioning
  @@index([code])
  @@index([order_number, order_reference_id, ewaybill], map: "order_global_search_idx")
}

model OrderSellerDetails {
  id String @id @default(cuid())

  seller_name    String? @db.VarChar(100)
  gst_no         String? @db.VarChar(15)
  contact_number String? @db.VarChar(15)

  order Order[] @relation("OrderSellerDetails")

  address_id String?
  address    Address? @relation(fields: [address_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// OrderItem Model
model OrderItem {
  id            String   @id @default(cuid())
  code          String   @unique // Custom ID - Format: OI-YYMM-XXXXX
  order_id      String
  order         Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  name          String?  @db.VarChar(255)
  sku           String?  @db.VarChar(50)
  units         Int?     @default(1)
  selling_price Float?
  discount      Float?   @default(0)
  tax           Float?   @default(0)
  hsn           String?  @db.VarChar(8)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([order_id])
  @@index([code])
  @@index([sku])
}

// Shipment Model
model Shipment {
  id     String         @id @default(cuid())
  code   String         @unique // Custom ID - Format: SH-YYMM-XXXXX
  awb    String?        @unique @db.VarChar(50)
  status ShipmentStatus @default(NEW)
  bucket Int            @default(1)

  shipping_charge Float?     @default(0)
  fw_charge       Float?     @default(0)
  cod_charge      Float?     @default(0)
  rto_charge      Float?     @default(0)
  order_zone      ZoneLabel?
  edd             DateTime?
  pickup_date     DateTime?
  pickup_id       String?
  routing_code    String?
  cancel_reason   String?
  is_reshipped    Boolean    @default(false)
  sr_shipment_id  String?    @db.VarChar(50)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order_id String @unique
  order    Order  @relation("OrderShipment", fields: [order_id], references: [id], onDelete: Cascade)

  user_id               String
  user                  User                  @relation("UserShipments", fields: [user_id], references: [id], onDelete: Cascade)
  courier_id            String?
  courier               Courier?              @relation(fields: [courier_id], references: [id], onDelete: Cascade)
  tracking_events       TrackingEvent[]
  pricing               ShipmentPricing?
  shipment_transactions ShipmentTransaction[]

  @@index([order_id, user_id, courier_id, status, created_at])
  @@index([awb])
  @@index([code])
  @@index([sr_shipment_id])
  @@index([created_at(sort: Desc)])
  @@index([awb], map: "shipment_awb_search_idx")
}

// TrackingEvent Model
model TrackingEvent {
  id          String         @id @default(cuid())
  status      String

  action      String?        @db.VarChar(100)
  location    String?        @db.VarChar(100)
  description String?        @db.VarChar(255)
  status_code String?        @db.VarChar(100)

  // Additional vendor-specific fields
  vendor_name        String?  @db.VarChar(100)
  vendor_status_code String?  @db.VarChar(100)
  vendor_status_label String? @db.VarChar(100)
  raw_data           Json?    // Store the complete raw tracking event data

  shipment_id String
  shipment    Shipment       @relation(fields: [shipment_id], references: [id], onDelete: Cascade)

  is_rto      Boolean        @default(false)
  bucket      Int?           @default(1)

  timestamp  DateTime @default(now())
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([shipment_id, timestamp])
}

model ChannelConfig {
  id        String  @id @default(cuid())
  name      String  @unique @db.VarChar(100) // SMARTSHIP, SHIPROCKET, DELHIVERY, SHOPIFY
  nickname  String  @unique @db.VarChar(10) // SS, SR, DL, SF
  is_active Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  couriers Courier[]
}

// Courier Model
model Courier {
  id           String  @id @default(cuid())
  code         String // Custom ID - Format: CR-YYMM-XXXXX
  name         String  @db.VarChar(100)
  courier_code String? @db.VarChar(50)

  cod_charge_hard    Float? @default(40)
  cod_charge_percent Float? @default(1.5)

  is_active           Boolean @default(true)
  is_reversed_courier Boolean @default(false)

  weight_slab      Float?
  weight_unit      String? @db.VarChar(10)
  increment_weight Float?

  type        DeliveryType @default(SURFACE)
  pickup_time String?      @db.VarChar(50)

  api_credentials Json? // Sparse, encrypted
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  shipments     Shipment[]
  plan_pricings PlanCourierPricing[]

  channel_config_id String
  channel_config    ChannelConfig @relation(fields: [channel_config_id], references: [id])

  @@unique([code, name, weight_slab])
  @@index([courier_code, is_active])
  @@index([code])
}

// UserWallet Model
model UserWallet {
  id                    String                      @id @default(cuid())
  code                  String                      @unique // Custom ID - Format: WL-YYMM-XXXXX
  balance               Float                       @default(0)
  user_id               String                      @unique
  user                  User                        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  shipment_transactions ShipmentTransaction[]
  invoice_transactions  InvoiceTransaction[]
  wallet_transactions   WalletRechargeTransaction[]
  created_at            DateTime                    @default(now())
  updated_at            DateTime                    @updatedAt

  @@index([user_id])
  @@index([code])
}

// ShipmentTransaction Model
model ShipmentTransaction {
  id                      String            @id @default(cuid())
  code                    String            @unique // Custom ID - Format: ST-YYMM-XXXXX
  amount                  Float
  type                    String            @db.VarChar(20) // CREDIT, DEBIT
  description             String            @db.VarChar(255)
  status                  TransactionStatus @default(PENDING)
  merchant_transaction_id String?           @unique @db.VarChar(50)
  currency                String            @default("INR") @db.VarChar(3)
  awb                     String?           @db.VarChar(50)
  sr_shipment_id          String?           @db.VarChar(50)
  created_at              DateTime          @default(now())
  updated_at              DateTime          @updatedAt

  wallet_id String
  wallet    UserWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation("UserShipmentTransactions", fields: [user_id], references: [id], onDelete: Cascade)

  shipment_id String
  shipment    Shipment @relation(fields: [shipment_id], references: [id], onDelete: Cascade)

  payment_id String?
  payment    Payment? @relation(fields: [payment_id], references: [id])

  @@index([wallet_id, user_id, status, created_at])
  @@index([merchant_transaction_id])
  @@index([awb])
  @@index([sr_shipment_id])
  @@index([code])
  @@index([created_at(sort: Desc)])
}

// InvoiceTransaction Model
model InvoiceTransaction {
  id                      String            @id @default(cuid())
  code                    String            @unique // Custom ID - Format: IT-YYMM-XXXXX
  amount                  Float
  type                    String            @db.VarChar(20) // CREDIT, DEBIT
  description             String            @db.VarChar(255)
  status                  TransactionStatus @default(PENDING)
  merchant_transaction_id String?           @unique @db.VarChar(50)
  currency                String            @default("INR") @db.VarChar(3)
  invoice_number          String?           @db.VarChar(50)
  created_at              DateTime          @default(now())
  updated_at              DateTime          @updatedAt

  wallet_id String
  wallet    UserWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation("UserInvoiceTransactions", fields: [user_id], references: [id], onDelete: Cascade)

  invoice_id String
  invoice    Invoice @relation(fields: [invoice_id], references: [id], onDelete: Cascade)

  payment_id String?
  payment    Payment? @relation(fields: [payment_id], references: [id])

  @@index([wallet_id, user_id, status, created_at])
  @@index([merchant_transaction_id])
  @@index([invoice_number])
  @@index([code])
  @@index([created_at(sort: Desc)])
}

// WalletRechargeTransaction Model
model WalletRechargeTransaction {
  id                      String            @id @default(cuid())
  code                    String            @unique // Custom ID - Format: WT-YYMM-XXXXX
  amount                  Float
  type                    String            @db.VarChar(20) // CREDIT, DEBIT
  description             String            @db.VarChar(255)
  status                  TransactionStatus @default(PENDING)
  merchant_transaction_id String?           @unique @db.VarChar(50)
  currency                String            @default("INR") @db.VarChar(3)
  created_at              DateTime          @default(now())
  updated_at              DateTime          @updatedAt

  wallet_id String
  wallet    UserWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation("UserWalletTransactions", fields: [user_id], references: [id], onDelete: Cascade)

  payment_id String?
  payment    Payment? @relation(fields: [payment_id], references: [id])

  @@index([wallet_id, user_id, status, created_at])
  @@index([merchant_transaction_id])
  @@index([code])
  @@index([created_at(sort: Desc)])
}

// Payment Model
model Payment {
  id                String            @id @default(cuid())
  code              String            @unique // Custom ID - Format: PY-YYMM-XXXXX
  amount            Float
  method            PaymentMethod
  status            TransactionStatus @default(PENDING)
  gateway_reference String?           @db.VarChar(50)
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  order_id String
  order    Order  @relation(fields: [order_id], references: [id], onDelete: Cascade)

  shipment_transactions ShipmentTransaction[]
  invoice_transactions  InvoiceTransaction[]
  wallet_transactions   WalletRechargeTransaction[]

  @@index([order_id, status])
  @@index([code])
  @@index([gateway_reference])
}

// Invoice Model
model Invoice {
  id             String    @id @default(cuid())
  code           String    @unique // Custom ID - Format: INV-YYMM-XXXXX
  invoice_number String    @db.VarChar(50)
  amount         Float
  tax_amount     Float?    @default(0)
  due_date       DateTime?
  is_paid        Boolean   @default(false)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  user_id  String
  user     User   @relation("UserInvoices", fields: [user_id], references: [id], onDelete: Cascade)
  order_id String @unique
  order    Order  @relation("OrderInvoice", fields: [order_id], references: [id], onDelete: Cascade)

  invoice_transactions InvoiceTransaction[]

  @@unique([order_id, invoice_number])
  @@index([user_id, invoice_number, created_at])
  @@index([code])
  @@index([created_at(sort: Desc)])
}

model Billing {
  id       String @id @default(cuid())
  code     String @unique // Custom ID - Format: BL-YYMM-XXXXX
  order_id String
  order    Order  @relation(fields: [order_id], references: [id], onDelete: Cascade)

  billing_date   DateTime
  billing_amount Float

  charged_weight        Float
  fw_excess_charge      Float
  rto_excess_charge     Float
  zone_change_charge    Float
  is_forward_applicable Boolean
  is_rto_applicable     Boolean

  base_price  Boolean
  base_weight Boolean

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  dispute Dispute[]

  @@unique([code, order_id])
}

// Dispute Model
model Dispute {
  id          String        @id @default(cuid())
  code        String        @unique // Custom ID - Format: DS-YYMM-XXXXX
  reason      String        @db.VarChar(255)
  description String        @db.Text
  status      DisputeStatus @default(OPENED)

  image            String?
  accepted         Boolean @default(false)
  stage            String?
  order_box_height Float?
  order_box_width  Float?
  order_box_length Float?
  order_size_unit  String?

  applicable_weight  Float? // 0.5 
  courier_weight     Float? // 1.5 
  excess_weight      Float? // 1 
  dispute_weight     Float? // 1.5 
  final_total_weight Float? // 1

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  billing_id String
  billing    Billing @relation(fields: [billing_id], references: [id])

  user_id  String
  user     User   @relation("UserDisputes", fields: [user_id], references: [id], onDelete: Cascade)
  order_id String @unique
  order    Order  @relation("OrderDispute", fields: [order_id], references: [id], onDelete: Cascade)

  @@unique([code, order_id])
  @@index([user_id, order_id, status])
}

// Remittance Model
model Remittance {
  id              String           @id @default(cuid())
  code            String           @unique // Custom ID - Format: RM-YYMM-XXXXX
  amount          Float
  status          RemittanceStatus @default(PENDING)
  remittance_id   String           @unique @db.VarChar(50)
  remittance_date DateTime
  cycle           RemittanceCycle  @default(WEEKLY)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  user_id String
  user    User   @relation("UserRemittances", fields: [user_id], references: [id], onDelete: Cascade)

  order_id String @unique
  order    Order  @relation("OrderRemittances", fields: [order_id], references: [id], onDelete: Cascade)

  @@index([user_id, status, remittance_date])
  @@index([remittance_id])
  @@index([code])
}

// Notification Model
model Notification {
  id           String           @id @default(cuid())
  code         String           @unique // Custom ID - Format: NT-YYMM-XXXXX
  type         NotificationType
  title        String           @db.VarChar(100)
  content      String           @db.Text
  is_read      Boolean          @default(false)
  recipient_id String // Single user ID for simplicity
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt

  @@index([recipient_id, is_read, created_at])
  @@index([code])
}

// ApiRequest Model
model ApiRequest {
  id              String   @id @default(cuid())
  endpoint        String   @db.VarChar(255)
  method          String   @db.VarChar(10)
  ip_address      String   @db.VarChar(45)
  user_id         String?
  user            User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  response_status Int?
  response_time   Int? // in milliseconds
  timestamp       DateTime @default(now())

  @@index([user_id, endpoint, timestamp])
}

// BulkOperation Model
model BulkOperation {
  id              String   @id @default(uuid())
  type            String // CREATE_SHIPMENT, SCHEDULE_PICKUP, CANCEL_SHIPMENT, DOWNLOAD_LABEL, EDIT_PICKUP_ADDRESS
  status          String // PENDING, PROCESSING, COMPLETED, FAILED
  code            String   @unique
  user_id         String
  total_count     Int      @default(0)
  processed_count Int      @default(0)
  success_count   Int      @default(0)
  failed_count    Int      @default(0)
  results         String?  @db.Text // JSON string of operation results
  report_path     String? // Path to CSV report file
  file_path       String? // Path to PDF or other output file
  error_message   String? // Error message if operation failed
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([type])
  @@index([status])
  @@index([created_at])
}

// Auth.js models
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Pincode {
  id       String @id @default(cuid())
  pincode  Int    @unique
  city     String
  state    String
  district String
  country  String @default("India")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([pincode])
}

// Plan Model
model Plan {
  id          String   @id @default(cuid())
  code        String   @unique // Custom ID - Format: PL-YYMM-XXXXX
  name        String   @unique @db.VarChar(100)
  description String?  @db.VarChar(255)
  isDefault   Boolean  @default(false)
  features    String[] @default([])

  is_active Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  plan_courier_pricings PlanCourierPricing[]
  users                 User[]

  @@index([isDefault])
  @@index([code])
}

// PlanCourierPricing Model
model PlanCourierPricing {
  id String @id @default(cuid())

  cod_charge_hard    Float? @default(40)
  cod_charge_percent Float? @default(1.5)

  is_fw_applicable           Boolean @default(true)
  is_rto_applicable          Boolean @default(true)
  is_cod_applicable          Boolean @default(true)
  is_cod_reversal_applicable Boolean @default(true)

  weight_slab      Float @default(0.5)
  increment_weight Float @default(0.5)
  increment_price  Float @default(0)

  zone_pricing ZonePricing[]

  plan_id    String
  plan       Plan    @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  courier_id String
  courier    Courier @relation(fields: [courier_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([plan_id, courier_id])
  @@index([courier_id])
}

model ZonePricing {
  id                  String    @id @default(cuid())
  zone                ZoneLabel
  base_price          Float
  increment_price     Float
  is_rto_same_as_fw   Boolean
  rto_base_price      Float
  rto_increment_price Float
  flat_rto_charge     Float

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  plan_courier_pricing_id String
  plan_courier_pricing    PlanCourierPricing @relation(fields: [plan_courier_pricing_id], references: [id])

  @@unique([plan_courier_pricing_id, zone])
  @@index([zone])
  @@index([plan_courier_pricing_id])
}

model ShipmentPricing {
  id                 String   @id @default(cuid())
  shipment_id        String   @unique
  shipment           Shipment @relation(fields: [shipment_id], references: [id])
  cod_charge_hard    Float?   @default(40)
  cod_charge_percent Float?   @default(1.5)

  is_fw_applicable           Boolean @default(true)
  is_rto_applicable          Boolean @default(true)
  is_cod_applicable          Boolean @default(true)
  is_cod_reversal_applicable Boolean @default(true)

  weight_slab      Float @default(0.5)
  increment_weight Float @default(0.5)
  increment_price  Float @default(0)

  zone                ZoneLabel
  base_price          Float
  is_rto_same_as_fw   Boolean
  rto_base_price      Float
  rto_increment_price Float
  flat_rto_charge     Float

  courier_other_zone_pricing_id String?                      @unique
  courier_other_zone_pricing    ShipmentCourierZonePricing[] @relation("CourierOtherZonePricing")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model ShipmentCourierZonePricing {
  id                  String    @id @default(cuid())
  zone                ZoneLabel
  base_price          Float
  increment_price     Float
  is_rto_same_as_fw   Boolean
  rto_base_price      Float
  rto_increment_price Float
  flat_rto_charge     Float

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  shipment_pricing_id String?
  shipment_pricing    ShipmentPricing? @relation("CourierOtherZonePricing", fields: [shipment_pricing_id], references: [id])

  @@index([zone])
}

// CourierStatusMapping Model
model CourierStatusMapping {
  id                 String  @id @default(cuid())
  courier_name       String  @db.VarChar(100) // Vendor name (SHIPROCKET, DELHIVERY, SMARTSHIP)
  status_code        String  @db.VarChar(50) // Original status code from courier
  status_label       String  @db.VarChar(100) // Status label from courier
  status_description String? @db.VarChar(255) // Status description from courier
  bucket             Int // Lorrigo bucket ID
  is_active          Boolean @default(true)
  is_mapped          Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([courier_name, status_code])
  @@index([courier_name, bucket])
  @@index([status_code])
}

// UnmappedCourierStatus Model
model UnmappedCourierStatus {
  id           String  @id @default(cuid())
  courier      String  @db.VarChar(100) // Vendor name (SHIPROCKET, DELHIVERY, SMARTSHIP)
  status_code  String  @db.VarChar(50) // Original status code from courier
  status_label String? @db.VarChar(100) // Status label from courier
  count        Int     @default(1) // Number of times this status has been seen
  last_seen    DateTime @default(now()) // Last time this status was seen

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([courier, status_code], name: "courier_status_code")
  @@index([courier])
  @@index([status_code])
}

// Shopify Connection Model
model ShopifyConnection {
  id           String   @id @default(cuid())
  shop         String   @db.VarChar(255)
  access_token String   @db.Text
  scope        String   @db.Text
  user_id      String   @unique
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  connected_at DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([user_id])
  @@index([shop])
}
